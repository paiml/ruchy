# PMAT Quality Gate Configuration (Certeza-aligned)
# Specification: docs/specifications/certeza-ideas-integration.md
# Based on: https://github.com/paiml/certeza

[gates]
# Run clippy linter
run_clippy = true

# Enforce strict clippy (-D warnings)
clippy_strict = true

# Run test suite
run_tests = true

# Test timeout in seconds
test_timeout = 300

# Check code coverage (Tier 2+)
check_coverage = true

# Minimum coverage percentage
# Current baseline: 68.42% (v3.211.0)
# Certeza target: 85% (minimum), 95% (goal)
# Transition plan: 68% → 75% → 80% → 85% → 95%
min_coverage = 68.0  # Prevent regressions while working toward 85%

# Check cyclomatic complexity (Toyota Way)
check_complexity = true

# Maximum cyclomatic complexity per function
max_complexity = 10  # Certeza standard (not 15, not 20, TEN!)

# Certeza-specific gates

[gates.satd]
# Self-Admitted Technical Debt (Zero tolerance)
enabled = true
max_count = 0  # Zero TODO, FIXME, HACK allowed
patterns = ["TODO", "FIXME", "HACK", "XXX", "BUG"]
require_issue_links = true  # All debt must link to GitHub issues
fail_on_violation = true

[gates.mutation]
# Mutation Testing (Tier 3 only - expensive)
enabled = false  # Manual via `make tier3-nightly`
min_score = 85.0  # Certeza minimum
tool = "cargo-mutants"
strategy = "incremental"  # Per-file, not full baseline
timeout_per_test = 300
fail_on_violation = false  # Warning only (can have equivalent mutants)

[gates.security]
# Security Audits
enabled = true
audit_vulnerabilities = "deny"  # Fail on known CVEs
audit_unmaintained = "warn"  # Warn on deprecated deps
max_unsafe_blocks = 0  # Forbid unsafe (QUALITY-002 policy)
fail_on_violation = true

[gates.documentation]
# Documentation Quality
enabled = true
min_rustdoc_coverage = 90.0  # 90% of public items documented
require_examples = true  # All public functions need examples
fail_on_violation = true

[gates.performance]
# Performance Regression Detection (Future: Tier 2)
enabled = false  # Deferred to Phase 2 (benchmarking integration)
max_regression_percent = 10.0  # Fail if >10% slower than baseline
baseline_file = "benchmarks/baseline.json"

# Tier-based enforcement

[tiers]
# Tier 1: ON-SAVE (sub-second) - Flow state
tier1_gates = ["clippy", "complexity"]  # Fast checks only

# Tier 2: ON-COMMIT (1-5 min) - Pre-commit gate
tier2_gates = ["clippy", "complexity", "tests", "coverage", "satd"]

# Tier 3: ON-MERGE/NIGHTLY (hours) - CI/CD gate
tier3_gates = ["clippy", "complexity", "tests", "coverage", "satd", "mutation", "security"]

[risk_based]
# Certeza Risk-Based Verification Strategy
# Resource Allocation: 40% of time on 5-10% highest-risk code

# Very High Risk: 90-95% mutation score
very_high_risk_mutation_target = 92.5
very_high_risk_components = [
    "src/runtime/actor_concurrent.rs",
    "src/runtime/eval_control_flow_new.rs",
    "src/backend/transpiler/codegen_minimal.rs",
]

# High Risk: 85-90% mutation score
high_risk_mutation_target = 87.5
high_risk_components = [
    "src/frontend/parser/**/*.rs",
    "src/backend/transpiler/**/*.rs",
    "src/runtime/eval*.rs",
]

# Medium Risk: 80-85% mutation score
medium_risk_mutation_target = 82.5
medium_risk_components = [
    "src/runtime/repl/**/*.rs",
    "src/quality/**/*.rs",
    "src/stdlib/**/*.rs",
]

# Low Risk: No mutation testing (90% coverage only)
low_risk_components = [
    "src/utils/**/*.rs",
    "src/testing/**/*.rs",
]
