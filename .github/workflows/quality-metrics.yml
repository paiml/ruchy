# O(1) Quality Gates - Metric Tracking Workflow for Ruchy
# Tracks quality metrics over time and posts regression warnings to PRs
# Integrates with Ruchy's Makefile targets

name: Quality Metrics Tracking

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  PROPTEST_CASES: 10  # Fast property testing for CI

jobs:
  track-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trend analysis

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install nightly (for fuzz tests)
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Install PMAT
        run: |
          # Install from crates.io or build from source
          if [ -d "../paiml-mcp-agent-toolkit" ]; then
            cargo install --path ../paiml-mcp-agent-toolkit/server --force
          else
            cargo install pmat-server --force
          fi

      - name: Install bashrs for shell linting
        run: |
          if [ -d "../bashrs" ]; then
            cargo install --path ../bashrs --force
          else
            cargo install bashrs --force
          fi

      - name: Record lint metric
        id: lint
        run: |
          START=$(date +%s%3N)
          make lint || true
          END=$(date +%s%3N)
          DURATION=$((END - START))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          pmat record-metric lint $DURATION

      - name: Record test-fast metric (TDD cycle)
        id: test-fast
        run: |
          START=$(date +%s%3N)
          make test-fast || true
          END=$(date +%s%3N)
          DURATION=$((END - START))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          pmat record-metric test-fast $DURATION

      - name: Record test-pre-commit metric (<30s target)
        id: test-pre-commit
        run: |
          START=$(date +%s%3N)
          make test-pre-commit-fast || true
          END=$(date +%s%3N)
          DURATION=$((END - START))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          pmat record-metric test-pre-commit $DURATION

      - name: Record coverage metric
        id: coverage
        run: |
          START=$(date +%s%3N)
          make coverage || true
          END=$(date +%s%3N)
          DURATION=$((END - START))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          pmat record-metric coverage $DURATION

      - name: Record binary size metric
        id: binary-size
        run: |
          make build || true
          BINARY_SIZE=$(stat -c%s target/release/ruchy 2>/dev/null || echo "0")
          echo "size=$BINARY_SIZE" >> $GITHUB_OUTPUT
          pmat record-metric binary-size $BINARY_SIZE

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v3
        with:
          name: quality-metrics
          path: .pmat-metrics/
          retention-days: 90

      - name: Analyze metric trends
        id: trends
        run: |
          pmat show-metrics --trend --format json > metrics-trend.json
          cat metrics-trend.json

      - name: Check for regressions (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          # Compare PR metrics against main baseline
          pmat predict-quality --all --failures-only --format json > regressions.json

          # Check if any metrics are regressing
          if [ -s regressions.json ] && [ "$(cat regressions.json)" != "[]" ]; then
            echo "âš ï¸ Quality metric regressions detected"
            cat regressions.json

            # Post comment to PR
            if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
              COMMENT="## âš ï¸ Quality Metric Regressions Detected\n\n"
              COMMENT="${COMMENT}$(cat regressions.json | jq -r '.[] | "### \(.metric)\n- **Status**: \(.direction)\n- **Predicted breach**: \(.breach_in_days // "unknown") days\n- **Recommendations**:\n\(.recommendations | map("  - " + .) | join("\n"))\n\n"')"

              gh pr comment ${{ github.event.pull_request.number }} \
                --body "$COMMENT" \
                || echo "Failed to post PR comment"
            fi
          else
            echo "âœ… No quality metric regressions detected"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate metric report
        if: always()
        run: |
          echo "## ðŸ“Š Ruchy Quality Metrics Report" > metrics-report.md
          echo "" >> metrics-report.md
          echo "**Commit**: \`${{ github.sha }}\`" >> metrics-report.md
          echo "**Branch**: \`${{ github.ref_name }}\`" >> metrics-report.md
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> metrics-report.md
          echo "" >> metrics-report.md

          echo "### Current Metrics" >> metrics-report.md
          echo "" >> metrics-report.md
          echo "| Metric | Value | Threshold | Status |" >> metrics-report.md
          echo "|--------|-------|-----------|--------|" >> metrics-report.md
          echo "| Lint | ${{ steps.lint.outputs.duration }}ms | 30,000ms | $([ "${{ steps.lint.outputs.duration }}" -lt "30000" ] && echo "âœ…" || echo "âŒ") |" >> metrics-report.md
          echo "| Test (fast) | ${{ steps.test-fast.outputs.duration }}ms | 300,000ms | $([ "${{ steps.test-fast.outputs.duration }}" -lt "300000" ] && echo "âœ…" || echo "âŒ") |" >> metrics-report.md
          echo "| Test (pre-commit) | ${{ steps.test-pre-commit.outputs.duration }}ms | 30,000ms | $([ "${{ steps.test-pre-commit.outputs.duration }}" -lt "30000" ] && echo "âœ…" || echo "âŒ") |" >> metrics-report.md
          echo "| Coverage | ${{ steps.coverage.outputs.duration }}ms | 600,000ms | $([ "${{ steps.coverage.outputs.duration }}" -lt "600000" ] && echo "âœ…" || echo "âŒ") |" >> metrics-report.md
          echo "| Binary Size | ${{ steps.binary-size.outputs.size }} bytes | 10,000,000 bytes | $([ "${{ steps.binary-size.outputs.size }}" -lt "10000000" ] && echo "âœ…" || echo "âŒ") |" >> metrics-report.md
          echo "" >> metrics-report.md

          echo "### Trend Analysis" >> metrics-report.md
          echo "" >> metrics-report.md
          pmat show-metrics --trend >> metrics-report.md || true

          cat metrics-report.md

      - name: Upload metrics report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: metrics-report
          path: metrics-report.md
          retention-days: 90

      - name: Run rust-project-score (weekly)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Run comprehensive rust-project-score on main branch pushes
          pmat rust-project-score --full --format markdown --output rust-score.md

          echo "## ðŸ¦€ Rust Project Score" >> metrics-report.md
          cat rust-score.md >> metrics-report.md

      - name: Upload rust-project-score
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v3
        with:
          name: rust-project-score
          path: rust-score.md
          retention-days: 90
